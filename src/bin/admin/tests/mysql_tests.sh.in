#!/bin/sh

# Copyright (C) 2014 Internet Systems Consortium, Inc. ("ISC")
#
# Permission to use, copy, modify, and/or distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH
# REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
# AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,
# INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
# LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE
# OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
# PERFORMANCE OF THIS SOFTWARE.

# Include common test library.
. @abs_top_builddir@/src/lib/testutils/dhcp_test_lib.sh

# If the code is installed, include admin-utils.sh from the destination
# directory. If not, include it from the sources.
prefix=@prefix@

if [ -e @datarootdir@/@PACKAGE_NAME@/scripts/admin-utils.sh ]; then
    . @datarootdir@/@PACKAGE_NAME@/scripts/admin-utils.sh
else
    . @abs_top_builddir@/src/bin/admin/admin-utils.sh
fi

db_user="keatest"
db_pass="keatest"
db_name="keatest"

# Set location of the kea-admin.
keactrl=@abs_top_builddir@/src/bin/admin/kea-admin

# Wipe all tables from the DB:
mysql_wipe() {
    printf "Wiping whole database %s\n" $db_name
    mysql -u$db_user -p$db_pass $db_name &>/dev/null <<EOF
SET @tables = NULL;
SELECT GROUP_CONCAT(table_schema, '.', table_name) INTO @tables
  FROM information_schema.tables
  WHERE table_schema = 'keatest';

SET @tables = CONCAT('DROP TABLE ', @tables);
PREPARE stmt FROM @tables;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;
EOF
}

mysql_init_test() {
    test_start "mysql.init"

    # Let's wipe the whole database
    mysql_wipe

    # Ok, now let's create a version 1.7
    mysql -u$db_user -p$db_pass $db_name &>/dev/null <<EOF
CREATE TABLE schema_version (
    version INT PRIMARY KEY NOT NULL,
    minor INT
    );
INSERT INTO schema_version VALUES (1, 7);
EOF

    version=$(${keactrl} version mysql -u $db_user -p $db_pass -n $db_name)

    printf "Reported version: %s, expected 1.7\n" $version

    assert_str_eq "1.7" ${version} "Expected kea-admin to return %s, returned value was %s"

    test_finish 0
}

mysql_version_test() {
    test_start "mysql.version"

    # @todo: Implement this

    test_finish 0
}

mysql_upgrade_test() {
    test_start "mysql.upgrade"

    # @todo: Implement this

    test_finish 0
}

mysql_init_test
mysql_version_test
mysql_upgrade_test
